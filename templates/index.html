<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è‹±æ–‡å¯«ä½œåˆ†æå™¨</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- Quill CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <!-- Quill JS -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>è‹±æ–‡å¯«ä½œåˆ†æå™¨</h1>

    <form id="analyze-form" enctype="multipart/form-data">
      <textarea name="text_content" id="text_content" placeholder="è«‹è¼¸å…¥æˆ–è²¼ä¸Šè‹±æ–‡æ–‡ç« å…§å®¹..." rows="15"></textarea>
      <div class="upload-section">
        <label for="file">æˆ–ä¸Šå‚³TXTæª”æ¡ˆï¼š</label>
        <input type="file" id="file" name="file" accept=".txt">
      </div>
      <button type="submit">é–‹å§‹åˆ†æ</button>
    </form>

    <div id="status" class="status"></div>

    <div class="tabs hidden">
      <button onclick="showTab('analysis')" id="tab1" class="hidden">åˆ†æçµæœ</button>
      <button onclick="showTab('editable')" id="tab2" class="hidden">å¯ç·¨è¼¯ç‰ˆæœ¬</button>
    </div>
    
    <div id="analysis" class="tab-content hidden">
      <div id="result" class="result hidden"></div>
    </div>
    
    <div id="editable" class="tab-content hidden" style="display: none;">
      <h2>åˆ†æçµæœç·¨è¼¯</h2>
      <div id="editor-container" class="hidden"></div>
          <!-- â­æ–°å¢ï¼šä¸‹è¼‰PDFçš„æŒ‰éˆ• (ä¸€é–‹å§‹æ˜¯éš±è—çš„) -->
      <div id="download-section" class="hidden">
        <button id="download-pdf-button" class="download-btn">ä¸‹è¼‰PDFçµæœ</button>
      </div>  
    </div>


    <!-- ç¯„ä¾‹æ–‡ç« å€å¡Š -->
    <div id="sample-article" class="sample-article hidden">
        <div id="sample-content" class="sample-content"></div>



  </div>

  <script>
    var quill = new Quill('#editor-container', {
      theme: 'snow',  // ä¸»é¡Œæ¨£å¼
      modules: {
        toolbar: [
          [{ 'header': '1'}, {'header': '2'}, { 'font': [] }],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          [{ 'align': [] }],
          ['bold', 'italic', 'underline'],
          ['link', 'blockquote'],
          ['image', 'video']
        ]
      }
    });


    const form = document.getElementById('analyze-form');
    const status = document.getElementById('status');
    const result = document.getElementById('result');
    const sampleCard = document.getElementById('sample-article');
    const sampleContent = document.getElementById('sample-content');
    const downloadSection = document.getElementById('download-section');
    const downloadButton = document.getElementById('download-pdf-button');
    const editor = document.getElementById('editor-container');
    const tab1 = document.getElementById('tab1');
    const tab2 = document.getElementById('tab2');
    const editable = document.getElementById('editable');
    const analysis = document.getElementById('analysis');

    // ğŸ“¥ ç•¶ä½¿ç”¨è€…é¸æ“‡ TXT æª”æ¡ˆæ™‚ï¼Œè®€å–ä¸¦å¡«å…¥ textarea
    document.getElementById('file').addEventListener('change', function () {
      const file = this.files[0];
      if (!file) return;

      if (file.name.endsWith('.txt')) {
        const reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById('text_content').value = e.target.result;
        };
        reader.readAsText(file, 'utf-8');
      } else {
        alert('è«‹ä¸Šå‚³ .txt æ ¼å¼çš„ç´”æ–‡å­—æª”æ¡ˆ');
        this.value = ''; // æ¸…ç©ºæª”æ¡ˆæ¬„ä½
      }
    });

    // è¡¨å–®æäº¤è™•ç†
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      status.textContent = 'è³‡æ–™åˆ†æä¸­ï¼Œè«‹ç¨å€™...';
      result.classList.add('hidden');
      sampleCard.classList.add('hidden');
      downloadSection.classList.add('hidden');  // â­é€å‡ºå‰å…ˆéš±è—ä¸‹è¼‰æŒ‰éˆ•
      editor.classList.add('hidden');
      tab1.classList.add('hidden');
      tab2.classList.add('hidden');
      editable.classList.add('hidden');
      analysis.classList.add('hidden');

      const formData = new FormData(form);

      try {
        const response = await fetch('/', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          const data = await response.json();
          status.textContent = 'åˆ†æå®Œæˆï¼';
          tab1.classList.remove('hidden');
          tab2.classList.remove('hidden');
          editable.classList.remove('hidden');
          analysis.classList.remove('hidden');

          // å¡å…¥ Quill ç·¨è¼¯å™¨ä¸­
          quill.root.innerHTML = data.result;
          editor.classList.remove('hidden');
          result.innerHTML = data.result;
          result.classList.remove('hidden');

          if (data.sample_article && data.sample_article.trim() !== '') {
            sampleContent.innerHTML = data.sample_article;
            sampleCard.classList.remove('hidden');
          }
          
          // é€™è£¡æ–°å¢ä¸€å€‹ä¸‹è¼‰æŒ‰éˆ•
          if (data.pdf_url) {
            const downloadButton = document.createElement("a");
              downloadButton.href = data.pdf_url;
              downloadButton.download = "analysis_result.pdf"; // ä¸‹è¼‰æª”å
              downloadButton.textContent = "ä¸‹è¼‰PDFå ±å‘Š";
              downloadButton.className = "download-btn"; // ä½ å¯ä»¥è‡ªå·±å®šç¾©CSSæ¨£å¼
              document.getElementById("result").appendChild(document.createElement("br"));
              document.getElementById("result").appendChild(downloadButton);
          }
          
          // é¡¯ç¤ºä¸‹è¼‰ PDF æŒ‰éˆ•
          downloadSection.classList.remove('hidden');
        } else {
          status.textContent = 'åˆ†æå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
        }
      } catch (error) {
        console.error('ç™¼ç”ŸéŒ¯èª¤:', error);
        status.textContent = 'é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
      }
    });


        // ä¸‹è¼‰ PDF æŒ‰éˆ•è™•ç†
        document.getElementById('download-pdf-button').addEventListener('click', function () {
      const content = quill.root.innerHTML;  // å–å¾— Quill ç·¨è¼¯å™¨ä¸­çš„å…§å®¹
      fetch('/generate_pdf', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: content })
      })
      .then(response => response.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'analysis_result.pdf';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
      })
      .catch(error => {
        console.error('ä¸‹è¼‰ PDF ç™¼ç”ŸéŒ¯èª¤:', error);
      });
    });



    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
      document.getElementById(tabId).style.display = 'block';

      // é¡å¤–æ§åˆ¶åˆ†æèˆ‡ç·¨è¼¯å€å¡Šçš„é¡¯ç¤ºï¼ˆå¯é¸ï¼‰
      if (tabId === 'analysis') {
        result.classList.remove('hidden');
        editor.classList.add('hidden');
      } else {
        result.classList.add('hidden');
        editor.classList.remove('hidden');
      }
    }

  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>è‹±æ–‡å¯«ä½œåˆ†æå™¨</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <!-- Supabase JS Client - ä¿æŒåŸæ¨£ï¼Œå› ç‚º checkAuth å’Œå¯èƒ½çš„å…¶ä»–å‰ç«¯äº¤äº’ä»éœ€ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.4/dist/umd/supabase.min.js"></script>
  
</head>

<body>
  <!-- ***** ä¿®æ”¹é–‹å§‹ï¼šä½¿ç”¨ Flask æ¨¡æ¿è®Šæ•¸ä¾†æ±ºå®šåˆå§‹é¡¯ç¤º ***** -->
  <div id="auth-status-area">
    {% if user_logged_in %}
    <p>æ­¡è¿ï¼Œ{{ user_email }}ï¼</p>
    <!-- <button id="history-button">æ­·å²ç´€éŒ„</button> REMOVE or repurpose -->
    <button id="logout-button">ç™»å‡º</button>
    {% else %}
    <p>ç™»å…¥ä¾†é€²è¡Œåˆ†æå§ï¼</p>
    <button id="login-button-main">ç™»å…¥</button>
    {% endif %}
  </div>

  <!-- ***** ä¿®æ”¹çµæŸ ***** -->
  <div id="sidebar">
    <h2>æ­·å²ç´€éŒ„</h2>
    <ul id="history-list">
      {% if user_email %}
      {% if history_data %}
      {% for record in history_data %}
      <li class="history-item" data-id="{{ record.id }}">
        <p><strong>åˆ†ææ™‚é–“ï¼š</strong>{{ record.created_at.strftime('%Y-%m-%d %H:%M:%S') if record.created_at else 'æœªçŸ¥' }}
        </p>
        <p class="history-item-summary"> <!-- Show a snippet of original text -->
                {{ record.original_text[:60] }}{% if record.original_text|length > 60 %}...{% endif %}
              </p>
      </li>
      {% endfor %}
      {% else %}
      <p>ç›®å‰æ²’æœ‰æ­·å²ç´€éŒ„ã€‚</p>
      {% endif %}
      {% else %}
      <p>è«‹å…ˆ<a href="{{ url_for('login') }}">ç™»å…¥</a>ä»¥æŸ¥çœ‹æ­·å²ç´€éŒ„ã€‚</p>
      {% endif %}
    </ul>
  </div>

  <div id="main-content">
    <div class="container">
      <h1>è‹±æ–‡å¯«ä½œåˆ†æå™¨</h1>

      <form id="analyze-form" enctype="multipart/form-data">
        <textarea name="text_content" id="text_content" placeholder="è«‹è¼¸å…¥æˆ–è²¼ä¸Šè‹±æ–‡æ–‡ç« å…§å®¹..." rows="15"></textarea>
        <div class="upload-section">
          <label for="file">æˆ–ä¸Šå‚³TXTæª”æ¡ˆï¼š</label>
          <input type="file" id="file" name="file" accept=".txt">
        </div>
        <button type="submit">é–‹å§‹åˆ†æ</button>
      </form>

      <div id="status" class="status hidden"></div>

      <div class="tabs hidden">
        <button onclick="showTab('analysis')" id="tab1" class="hidden">åˆ†æçµæœ</button>
        <button onclick="showTab('editable')" id="tab2" class="hidden">å¯ç·¨è¼¯ç‰ˆæœ¬</button>
      </div>

      <div id="analysis" class="tab-content hidden">
        <div id="result" class="result hidden"></div>
        <div id="original-pdf-download-container" style="text-align: center; ">
        
        </div>
      </div>
      <div id="editable" class="tab-content hidden" style="display: none;">
        <h2>åˆ†æçµæœç·¨è¼¯</h2>
        <div id="editor-container" class="hidden"></div>
        <div id="download-section" class="hidden">
          <button id="download-pdf-button" class="download-btn">ä¸‹è¼‰ç·¨è¼¯å¾ŒPDF</button> <!-- ä¿®æ”¹æŒ‰éˆ•æ–‡å­— -->
        </div>
      </div>

      <div id="sample-article" class="sample-article hidden">
        <div id="sample-content" class="sample-content"></div>
      </div>
      
      <!-- â­â­ æ–°å¢ï¼šæ»¾å‹•æŒ‰éˆ• â­â­ -->
      <div id="scroll-buttons-container">
        <button id="scroll-to-top-btn" title="æ»¾å‹•åˆ°é ‚éƒ¨">â†‘</button> <!-- æˆ–ä½¿ç”¨åœ–ç¤º -->
        <button id="scroll-to-bottom-btn" title="æ»¾å‹•åˆ°åº•éƒ¨">â†“</button> <!-- æˆ–ä½¿ç”¨åœ–ç¤º -->
      </div>

      <!-- æ¨¡å¼åˆ‡æ›æŒ‰éˆ• -->
      <button id="theme-toggle-button" title="åˆ‡æ›è‰²å½©æ¨¡å¼">
        <span class="sun-icon">ğŸŒ</span> <!-- å¤ªé™½åœ–ç¤º (Unicode) -->
        <span class="moon-icon">ğŸŒ›</span> <!-- æœˆäº®åœ–ç¤º (Unicode) -->
      </button>
    </div>
  </div>

  <script>
    // Supabase Client åˆå§‹åŒ– (ä¿æŒä¸è®Šï¼Œå¦‚æœ checkAuth ä»éœ€)
    const SUPABASE_URL = 'https://ltjzrbkyyaheyhdiozio.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0anpyYmt5eWFoZXloZGlvemlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2OTM3ODMsImV4cCI6MjA2MjI2OTc4M30.Ia_-T5VWVntKVTGvtF9h0j2amnM3BFunh9aPd3vRui4';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


    var quill = new Quill('#editor-container', {
      theme: 'snow',  // ä¸»é¡Œæ¨£å¼
      modules: {
        toolbar: [
          [{ 'header': '1' }, { 'header': '2' }, { 'font': [] }],
          [{ 'list': 'ordered' }, { 'list': 'bullet' }],
          [{ 'align': [] }],
          ['bold', 'italic', 'underline'],
          ['link', 'blockquote'],
          ['image', 'video']
        ]
      }
    });
    const form = document.getElementById('analyze-form');
    const statusEl = document.getElementById('status'); // Renamed to avoid conflict with window.status
    const resultEl = document.getElementById('result'); // Renamed
    const sampleCard = document.getElementById('sample-article');
    const sampleContent = document.getElementById('sample-content');
    const downloadSection = document.getElementById('download-section');
    const editorContainer = document.getElementById('editor-container'); // Renamed
    const tab1 = document.getElementById('tab1');
    const tab2 = document.getElementById('tab2');
    const tabsContainer = document.querySelector('.tabs'); // Tabs çš„çˆ¶å®¹å™¨
    //const originalPdfDownloadContainer = document.getElementById('original-pdf-download-container');
    const editableTabContent = document.getElementById('editable'); // Renamed
    const analysisTabContent = document.getElementById('analysis'); // Renamed
    const textContentArea = document.getElementById('text_content');
    const historyList = document.getElementById('history-list'); // Get the history list UL
    const analysisTab = document.getElementById('tab1');
    const editableTab = document.getElementById('tab2');
    const analysisResultDiv = document.getElementById('result');
    const editorContainerDiv = document.getElementById('editor-container'); // quill is linked to this
    //const downloadOriginalPdfButtonContainer = document.createElement('div'); // For dynamically adding the PDF button
    const downloadOriginalPdfButtonContainer = document.getElementById('original-pdf-download-container'); 
    //resultEl.parentNode.insertBefore(downloadOriginalPdfButtonContainer, resultEl.nextSibling);

    document.getElementById('file').addEventListener('change', function () {
      const file = this.files[0];
      if (!file) return;

      if (file.name.endsWith('.txt')) {
        const reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById('text_content').value = e.target.result;
        };
        reader.readAsText(file, 'utf-8');
      } else {
        alert('è«‹ä¸Šå‚³ .txt æ ¼å¼çš„ç´”æ–‡å­—æª”æ¡ˆ');
        this.value = ''; // æ¸…ç©ºæª”æ¡ˆæ¬„ä½
      }
    });

        // Function to clear current analysis display
    function clearAnalysisDisplay() {
      console.log("Clearing analysis display...");
        resultEl.innerHTML = '';
        resultEl.classList.add('hidden');
        if (quill) {
            quill.root.innerHTML = ''; // Clear Quill editor
        }
        if (downloadOriginalPdfButtonContainer) {
            downloadOriginalPdfButtonContainer.innerHTML = ''; // æ¸…ç©ºåŸå§‹ PDF ä¸‹è¼‰æŒ‰éˆ•
        }
        statusEl.classList.remove('error');
        tabsContainer.classList.add('hidden');
        analysisTabContent.classList.add('hidden'); 
        editableTabContent.classList.add('hidden');
        editorContainerDiv.classList.add('hidden');
        analysisTab.classList.add('hidden');
        editableTab.classList.add('hidden');
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        downloadSection.classList.add('hidden');
        statusEl.classList.add('hidden');
        // Remove any existing "Download Original PDF" button
        const existingBtn = resultEl.querySelector('download-original-pdf-button');
        //if (existingBtn) existingBtn.remove();
    }


    
    // Function to display fetched/loaded history item
    function displayHistoryItem(data) {
        console.log("Displaying history item. Data:", data); // 6. Is this function called? What's in data?
        clearAnalysisDisplay(); // å…ˆèª¿ç”¨æ¸…ç†å‡½æ•¸

        textContentArea.value = data.original_text || '';
        console.log("Set textarea to:", data.original_text);

        // data.html_for_result_tab æ˜¯å®Œæ•´çš„ HTMLï¼Œç”¨æ–¼ #result div
        // data.html_for_quill_editor æ˜¯æå–å¾Œçš„æ ¸å¿ƒ HTMLï¼Œç”¨æ–¼ Quill
        if (data.html_for_result_tab || data.html_for_quill_editor) {
            if (data.html_for_result_tab) {
                analysisResultDiv.innerHTML = data.html_for_result_tab;
                console.log("Set analysisResultDiv HTML with FULL HTML from history.");
            } else {
                analysisResultDiv.innerHTML = "<p>åˆ†æçµæœé¡¯ç¤ºå…§å®¹ç¼ºå¤±ã€‚</p>";
            }

            if (quill && data.html_for_quill_editor !== undefined) { // ç¢ºä¿å­—æ®µå­˜åœ¨ï¼Œå³ä½¿æ˜¯ç©ºä¸²
                quill.root.innerHTML = data.html_for_quill_editor;
                console.log("Set Quill editor HTML with CORE content from history:", (data.html_for_quill_editor || "").substring(0, 200) + "...");
            } else if (quill) {
                quill.root.innerHTML = ""; // å¦‚æœæ ¸å¿ƒå…§å®¹ç¼ºå¤±ï¼Œæ¸…ç©ºQuill
                console.warn("Core content for Quill (history) is undefined or missing.");
            }
            // â­â­â­ ç‚ºæ­·å²è¨˜éŒ„å‰µå»ºä¸¦æ·»åŠ ä¸‹è¼‰åŸå§‹ PDF çš„æŒ‰éˆ• â­â­â­
            if (downloadOriginalPdfButtonContainer) {
                downloadOriginalPdfButtonContainer.innerHTML = ''; // æ¸…ç©º
                if (data.pdf_url) { // æª¢æŸ¥æ­·å²è¨˜éŒ„æ•¸æ“šä¸­æ˜¯å¦æœ‰ pdf_url
                    const downloadBtn = document.createElement('a');
                    downloadBtn.href = data.pdf_url;
                    downloadBtn.textContent = 'ä¸‹è¼‰åŸå§‹å ±å‘Š (PDFæª”)';
                    downloadBtn.className = 'button-like download-original-pdf-button';
                    downloadOriginalPdfButtonContainer.appendChild(downloadBtn);
                    console.log("Original PDF download button added for history item with URL:", data.pdf_url);
                } else {
                    console.warn("pdf_url not found in history data.");
                    // å¯ä»¥é¸æ“‡åœ¨æ­¤è™•ä¸é¡¯ç¤ºæŒ‰éˆ•ï¼Œæˆ–è€…é¡¯ç¤ºä¸€å€‹æç¤ºä¿¡æ¯
                }
            } else {
                console.error("Element with ID 'original-pdf-download-container' not found for history item!");
            }

            statusEl.textContent = 'å·²è¼‰å…¥æ­·å²ç´€éŒ„ã€‚';
            statusEl.classList.remove('hidden');
            tabsContainer.classList.remove('hidden');
            editorContainerDiv.classList.remove('hidden');
            analysisTab.classList.remove('hidden');
            editableTab.classList.remove('hidden');
            resultEl.classList.remove('hidden');
            downloadSection.classList.remove('hidden');

            // then call showTab IF it does more than just display toggling (like active button states)
            showTab('analysis'); 
            console.log("Tabs and content visibility updated.");
        } else {
          analysisResultDiv.innerHTML = '<p>åˆ†æçµæœå…§å®¹ä¸å­˜åœ¨æˆ–ç„¡æ³•è¼‰å…¥ã€‚</p>';
          if (quill) quill.root.innerHTML = '';
          console.warn("Both full HTML and core HTML for Quill are missing in history data.");
          
          resultEl.classList.add('hidden');
          sampleCard.classList.add('hidden');
          downloadSection.classList.add('hidden');  // â­é€å‡ºå‰å…ˆéš±è—ä¸‹è¼‰æŒ‰éˆ•
          editorContainer.classList.add('hidden');
          tab1.classList.add('hidden');
          tab2.classList.add('hidden');
          editableTabContent.classList.add('hidden');
          analysisTabContent.classList.add('hidden');
        }
        console.log("displayHistoryItem finished.");
    }
        

    // Event listener for history items
    if (historyList) {

      historyList.addEventListener('mouseover', function(e) {
        const listItem = e.target.closest('.history-item');
        if (listItem) {
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰åˆªé™¤æŒ‰éˆ•ï¼Œé¿å…é‡è¤‡æ·»åŠ 
            if (!listItem.querySelector('.delete-history-btn')) {
                const deleteBtn = document.createElement('button');
                //eleteBtn.innerHTML = 'ğŸ—‘ï¸'; // åƒåœ¾æ¡¶åœ–ç¤º (Unicode)
                deleteBtn.className = 'delete-history-btn';
                deleteBtn.title = 'åˆªé™¤æ­¤ç´€éŒ„';
                deleteBtn.dataset.itemId = listItem.dataset.id; // å°‡ item ID å­˜å„²åœ¨æŒ‰éˆ•ä¸Š
                // â­ å‰µå»º img å…ƒç´ ä¾†é¡¯ç¤ºåœ–ç‰‡ â­
                const imgIcon = document.createElement('img');
                imgIcon.src = "{{ url_for('static', filename='images/trash_icon.png') }}"; // â­ ä½¿ç”¨ url_for ç”Ÿæˆåœ–ç‰‡è·¯å¾‘
                // æˆ–è€… imgIcon.src = "/static/images/trash_icon.png"; // ç›´æ¥å¯«è·¯å¾‘ä¹Ÿå¯ä»¥ï¼Œä½† url_for æ›´ä½³
                imgIcon.alt = 'åˆªé™¤'; // ç‚ºåœ–ç‰‡æ·»åŠ  alt æ–‡æœ¬ï¼Œæé«˜å¯è¨ªå•æ€§
                // å¯ä»¥é€šé CSS æ§åˆ¶åœ–ç‰‡å¤§å°ï¼Œæˆ–è€…ç›´æ¥åœ¨ JS ä¸­è¨­ç½®
                // imgIcon.style.width = '16px'; 
                // imgIcon.style.height = '16px';
                // imgIcon.style.verticalAlign = 'middle'; // å˜—è©¦å‚ç›´å±…ä¸­åœ–ç‰‡

                deleteBtn.appendChild(imgIcon); // å°‡åœ–ç‰‡æ·»åŠ åˆ°æŒ‰éˆ•ä¸­

                // å°‡åˆªé™¤æŒ‰éˆ•æ·»åŠ åˆ°åˆ—è¡¨é …çš„æœ«å°¾
                listItem.appendChild(deleteBtn);
            }
        }
    });

      historyList.addEventListener('mouseout', function(e) {
          const listItem = e.target.closest('.history-item');
          if (listItem && !listItem.contains(e.relatedTarget)) { // ç¢ºä¿é¼ æ¨™ç§»å‡ºäº†æ•´å€‹åˆ—è¡¨é …
              const deleteBtn = listItem.querySelector('.delete-history-btn');
              if (deleteBtn) {
                  // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘è®“ CSS æ§åˆ¶é¡¯ç¤º/éš±è—
                  // deleteBtn.remove(); // æˆ–è€…ç›´æ¥ç§»é™¤ï¼Œä¸‹æ¬¡æ‡¸åœå†å‰µå»º
              }
          }
      });
      
      historyList.addEventListener('click', async (e) => {
        const deleteButton = e.target.closest('.delete-history-btn');
        const historyItemLink = e.target.closest('.history-item:not(.delete-history-btn)'); // ç¢ºä¿é»æ“Šçš„æ˜¯æ¢ç›®æœ¬èº«è€Œä¸æ˜¯åˆªé™¤æŒ‰éˆ•

        if (deleteButton) {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°çˆ¶ç´šçš„ historyItemLink é»æ“Šäº‹ä»¶
            const itemIdToDelete = deleteButton.dataset.itemId;
            const listItemToDelete = deleteButton.closest('.history-item'); // æ‰¾åˆ°çˆ¶ç´š li

            if (itemIdToDelete && listItemToDelete) {
                // å½ˆå‡ºç¢ºèªå°è©±æ¡†
                if (window.confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™æ¢æ­·å²ç´€éŒ„å—ï¼Ÿ')) {
                    statusEl.textContent = 'æ­£åœ¨åˆªé™¤æ­·å²ç´€éŒ„...';
                    statusEl.classList.remove('hidden', 'error');

                    try {
                        const response = await fetch(`/delete_history_item/${itemIdToDelete}`, {
                            method: 'DELETE',
                            headers: {
                                // å¦‚æœä½ çš„å¾Œç«¯éœ€è¦ CSRF token æˆ–å…¶ä»–èªè­‰é ­ï¼Œåœ¨é€™è£¡æ·»åŠ 
                                // 'X-CSRF-TOKEN': 'your_csrf_token_here',
                                'Accept': 'application/json',
                            }
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            statusEl.textContent = data.message || 'æ­·å²ç´€éŒ„å·²åˆªé™¤ã€‚';
                            listItemToDelete.remove(); // å¾å‰ç«¯åˆ—è¡¨ä¸­ç§»é™¤
                            console.log(`History item ${itemIdToDelete} deleted successfully.`);
                            // å¯é¸ï¼šå¦‚æœç•¶å‰é¡¯ç¤ºçš„æ˜¯è¢«åˆªé™¤çš„è¨˜éŒ„ï¼Œå‰‡æ¸…ç†ä¸»å…§å®¹å€
                            if (analysisResultDiv.dataset.currentHistoryId === itemIdToDelete) {
                                clearAnalysisDisplay();
                            }
                        } else {
                            statusEl.textContent = `åˆªé™¤å¤±æ•—: ${data.error || response.statusText}`;
                            statusEl.classList.add('error');
                            console.error(`Failed to delete history item ${itemIdToDelete}:`, data.error || response.statusText);
                        }
                    } catch (error) {
                        statusEl.textContent = 'åˆªé™¤æ­·å²ç´€éŒ„æ™‚ç™¼ç”Ÿé€£ç·šéŒ¯èª¤ã€‚';
                        statusEl.classList.add('error');
                        console.error('Network error deleting history item:', error);
                    }
                }
            }
        } else if (historyItemLink) { // è™•ç†æ­£å¸¸çš„æ­·å²æ¢ç›®é»æ“Š (åŠ è¼‰å…§å®¹)
            // console.log("History list clicked for loading content");
            const listItem = historyItemLink; // e.target.closest('.history-item');
            
            if (!listItem) {
                console.log("Clicked target is not a .history-item or its child.");
                return;
            }
            console.log("Clicked history item:", listItem); // 2. Is the correct <li> element logged?

            const itemId = listItem.dataset.id;
            if (!itemId) {
                console.error("History item is missing data-id attribute.");
                return;
            }
            console.log("Fetching history item with ID:", itemId); // 3. Is the correct ID logged?

            // ... (rest of the handler: active class, statusEl, clearAnalysisDisplay) ...
            // Make sure clearAnalysisDisplay() is not erroring out. Add console.log inside it.
            // â­â­â­ åœ¨ fetch ä¹‹å‰æ¸…ç†é¡¯ç¤º â­â­â­
            statusEl.textContent = 'æ­£åœ¨è¼‰å…¥æ­·å²ç´€éŒ„...';
            statusEl.classList.remove('hidden');
            clearAnalysisDisplay(); // èª¿ç”¨æ¸…ç†å‡½æ•¸

            // ç§»é™¤å…ˆå‰ active çš„ class
            const currentlyActive = historyList.querySelector('.active-history-item');
            if (currentlyActive) {
                currentlyActive.classList.remove('active-history-item');
            }
            // çµ¦ç•¶å‰é»æ“Šçš„é …ç›®æ·»åŠ  active class
            if (listItem) {
                listItem.classList.add('active-history-item');
            }
            try {
              const response = await fetch(`/get_history_item/${itemId}`);
              console.log("Fetch response status:", response.status); // 4. What's the status?

              if (response.ok) {
                const data = await response.json();
                console.log("Data received from /get_history_item:", data); // 5. What data did you get?

                if (data.error) {
                    statusEl.textContent = `è¼‰å…¥æ­·å²ç´€éŒ„å¤±æ•—: ${data.error}`;
                    console.error("Error from server:", data.error);
                } else {
                    // Call displayHistoryItem and ensure it's working
                    console.log("Calling displayHistoryItem with data:", data);
                    displayHistoryItem(data);
                }
              } else {
                statusEl.textContent = `è¼‰å…¥æ­·å²ç´€éŒ„å¤±æ•— (${response.status})`;
                const errorText = await response.text();
                console.error(`Error fetching history item: ${response.status}`, errorText);
              }
            } catch (error) {
              statusEl.textContent = 'è¼‰å…¥æ­·å²ç´€éŒ„æ™‚ç™¼ç”Ÿé€£ç·šéŒ¯èª¤ã€‚';
              console.error('Network error fetching history item:', error);
            }
        }
      });
    } else {
        console.error("Element with ID 'history-list' not found!");
    }

    const formData = new FormData(form);
    console.log("Client-side FormData entries before fetch:");
    for (let [key, value] of formData.entries()) {
      console.log(`Key: ${key}, Value:`, value); // For file, value is a File object
    }
    console.log("Textarea content directly:", document.getElementById('text_content').value);
    console.log("File input files directly:", document.getElementById('file').files);

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = 'è³‡æ–™åˆ†æä¸­ï¼Œè«‹ç¨å€™...';
      statusEl.classList.remove('hidden'); // ç§»é™¤ error class ä»¥é˜²ä¸Šæ¬¡æ˜¯éŒ¯èª¤
      
      statusEl.classList.remove('hidden', 'error'); // ç§»é™¤ error class ä»¥é˜²ä¸Šæ¬¡æ˜¯éŒ¯èª¤
      //clearAnalysisDisplay(); // èª¿ç”¨æ¸…ç†å‡½æ•¸

      resultEl.classList.add('hidden');
      sampleCard.classList.add('hidden');
      downloadSection.classList.add('hidden');  // â­é€å‡ºå‰å…ˆéš±è—ä¸‹è¼‰æŒ‰éˆ•
      editorContainer.classList.add('hidden');
      tab1.classList.add('hidden');
      tab2.classList.add('hidden');
      editableTabContent.classList.add('hidden');
      analysisTabContent.classList.add('hidden');

      const formData = new FormData(form);
      
      try {
        const response = await fetch("{{ url_for('index') }}", { // ä½¿ç”¨ url_for ç”Ÿæˆè·¯å¾‘æ›´ä½³
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          const data = await response.json();
          
          if (data.error && data.login_required) { // è™•ç† Flask è¿”å›çš„éœ€è¦ç™»å…¥éŒ¯èª¤
            statusEl.textContent = data.error;
            window.location.href = "{{ url_for('login') }}"; // è·³è½‰åˆ°ç™»å…¥é é¢
            return;
          }
          if (data.error) { // å…¶ä»–éŒ¯èª¤
            statusEl.textContent = 'åˆ†æå¤±æ•—ï¼š' + data.error;
            return;
          }
          tabsContainer.classList.remove('hidden');
          statusEl.textContent = 'åˆ†æå®Œæˆï¼';
          statusEl.classList.remove('hidden');
          tab1.classList.remove('hidden');
          tab2.classList.remove('hidden');
          editableTabContent.classList.remove('hidden');
          analysisTabContent.classList.remove('hidden');
          quill.root.innerHTML = data.result;
          editorContainer.classList.remove('hidden');
          resultEl.innerHTML = data.result;
          resultEl.classList.remove('hidden');

          if (data.html_for_result_tab) {
              resultEl.innerHTML = data.html_for_result_tab;
              console.log("Set resultEl HTML with FULL HTML from analysis.");
          } else {
              resultEl.innerHTML = "<p>åˆ†æçµæœé¡¯ç¤ºå…§å®¹ç¼ºå¤±ã€‚</p>";
          }

          // ... è™•ç† sample_article (å¦‚æœæœ‰çš„è©±) ...
          // 3. å¡«å……åˆ†æçµæœåˆ° Quill ç·¨è¼¯å™¨ â­â­â­
          if (quill && data.html_for_quill_editor !== undefined) {
              quill.root.innerHTML = data.html_for_quill_editor;
              console.log("Set Quill editor HTML with CORE content from analysis:", (data.html_for_quill_editor || "").substring(0, 200) + "...");
          } else if (quill) {
              quill.root.innerHTML = "";
              console.warn("Core content for Quill (analysis) is undefined or missing.");
          }
            // editorContainer.classList.remove('hidden'); // ç”± showTab('editable') æ§åˆ¶

          // â­â­â­ ç‚ºæ­·å²è¨˜éŒ„å‰µå»ºä¸¦æ·»åŠ ä¸‹è¼‰åŸå§‹ PDF çš„æŒ‰éˆ• â­â­â­
          if (downloadOriginalPdfButtonContainer) {
              downloadOriginalPdfButtonContainer.innerHTML = ''; // æ¸…ç©º
              if (data.pdf_url) { // å‡è¨­æ­·å²è¨˜éŒ„çš„ data ä¹ŸåŒ…å« pdf_url
                  const downloadBtnLink = document.createElement('a');
                  downloadBtnLink.href = data.pdf_url;
                  downloadBtnLink.textContent = 'ä¸‹è¼‰åŸå§‹å ±å‘Š (PDFæª”)';
                  downloadBtnLink.className = 'button-like download-original-pdf-button';
                  
                  downloadOriginalPdfButtonContainer.appendChild(downloadBtnLink); // â­ å°‡ <a> æ¨™ç±¤æ·»åŠ åˆ°å®¹å™¨ä¸­
                  console.log("Original PDF download button (<a> tag) added for history item to container with URL:", data.pdf_url);
              } else {
                  console.warn("pdf_url not found in history data.");
              }
          } else {
              console.error("Element with ID 'original-pdf-download-container' not found for history item!");
          }

          downloadSection.classList.remove('hidden'); // é¡¯ç¤ºç·¨è¼¯å¾Œä¸‹è¼‰çš„å€å¡Š
          showTab('analysis'); // é è¨­é¡¯ç¤ºåˆ†æçµæœ tab
        } else if (response.status === 401) { // æœªæˆæ¬Š
          const errorData = await response.json();
          statusEl.textContent = errorData.error || 'è«‹å…ˆç™»å…¥å¾Œå†é€²è¡Œåˆ†æã€‚';
          window.location.href = "{{ url_for('login') }}"; // è·³è½‰åˆ°ç™»å…¥é é¢
        } else {
          const errorData = await response.json();
          statusEl.textContent = `åˆ†æå¤±æ•— (${response.status})ï¼š${errorData.error || 'è«‹ç¨å¾Œå†è©¦ã€‚'}`;
        }
      } catch (error) {
        console.error('ç™¼ç”ŸéŒ¯èª¤:', error);
        statusEl.textContent = 'é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
      }
    });

    document.getElementById('download-pdf-button').addEventListener('click', async function () {
      const content = quill.root.innerHTML;
      try {
        const response = await fetch("{{ url_for('generate_pdf') }}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: content })
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          // a.download = 'analysis_result_edited.pdf'; // å¾Œç«¯ send_file æœƒè™•ç†æª”å
          // å¾ Content-Disposition ç²å–æª”å
          const contentDisposition = response.headers.get('content-disposition');
          let fileName = 'analysis_edited_result.pdf';
          if (contentDisposition) {
            const fileNameMatch = contentDisposition.match(/filename="?(.+)"?/i);
            if (fileNameMatch && fileNameMatch.length === 2)
              fileName = fileNameMatch[1];
          }
          a.download = fileName;

          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          a.remove();
        } else if (response.status === 401) {
          const errorData = await response.json();
          alert(errorData.error || "è«‹å…ˆç™»å…¥å¾Œå†æ“ä½œã€‚");
          window.location.href = "{{ url_for('login') }}";
        }
        else {
          const errorData = await response.json();
          alert('ä¸‹è¼‰ç·¨è¼¯å¾Œ PDF å¤±æ•—: ' + (errorData.error || response.statusText));
        }
      } catch (error) {
        console.error('ä¸‹è¼‰ PDF ç™¼ç”ŸéŒ¯èª¤:', error);
        alert('ä¸‹è¼‰ PDF ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚');
      }
    });

    function showTab(tabId) {
    console.log("Showing tab:", tabId);
    // éš±è—æ‰€æœ‰ tab content å€å¡Š
    document.querySelectorAll('.tab-content').forEach(el => {
        el.style.display = 'none'; // æˆ–è€… el.classList.add('hidden');
        el.classList.add('hidden'); // çµ±ä¸€ä½¿ç”¨ hidden class
    });

    // é¡¯ç¤ºç›®æ¨™ tab content å€å¡Š
    const targetTabContent = document.getElementById(tabId);
    if (targetTabContent) {
        targetTabContent.style.display = 'block'; // æˆ–è€… targetTabContent.classList.remove('hidden');
        targetTabContent.classList.remove('hidden'); // çµ±ä¸€ä½¿ç”¨ hidden class
        console.log(tabId + " content displayed.");
    } else {
        console.error("Target tab content not found for id:", tabId);
        return;
    }

    // æ›´æ–° Tab æŒ‰éˆ•çš„ active ç‹€æ…‹ (å¦‚æœæœ‰çš„è©±)
    // å‡è¨­ä½ çš„ tab æŒ‰éˆ• ID æ˜¯ tab1 (å°æ‡‰ analysis) å’Œ tab2 (å°æ‡‰ editable)
    const tabButtons = [tab1, tab2]; // tab1 å’Œ tab2 æ˜¯ä½ ä¹‹å‰ç²å–çš„æŒ‰éˆ•å…ƒç´ 
    tabButtons.forEach(button => {
        if (button) button.classList.remove('active-tab'); // å‡è¨­ä½ æœ‰ 'active-tab' class
    });

    if (tabId === 'analysis' && tab1) {
        if (tab1) tab1.classList.add('active-tab');
        resultEl.classList.remove('hidden');         // é¡¯ç¤ºåˆ†æçµæœ div
        editorContainer.classList.add('hidden');   // éš±è— Quill ç·¨è¼¯å™¨ div
        console.log("#result shown, #editor-container hidden");
    } else if (tabId === 'editable' && tab2) {
        if (tab2) tab2.classList.add('active-tab');
        resultEl.classList.add('hidden');            // éš±è—åˆ†æçµæœ div
        editorContainer.classList.remove('hidden');  // é¡¯ç¤º Quill ç·¨è¼¯å™¨ div
        console.log("#result hidden, #editor-container shown");
    }
}

    // ***** ä¿®æ”¹å¾Œçš„ Auth æŒ‰éˆ•äº‹ä»¶ç›£è½ *****
    // ç™»å…¥æŒ‰éˆ• (å¦‚æœå­˜åœ¨)
    const loginButtonMain = document.getElementById('login-button-main');
    if (loginButtonMain) {
      loginButtonMain.addEventListener("click", function () {
        window.location.href = "{{ url_for('login') }}";
      });
    }

    // ç™»å‡ºæŒ‰éˆ• (å¦‚æœå­˜åœ¨)
    const logoutButton = document.getElementById('logout-button');
    if (logoutButton) {
      logoutButton.addEventListener("click", function () {
        // ä¸»è¦å‹•ä½œæ˜¯è·³è½‰åˆ° Flask çš„ç™»å‡ºè·¯ç”±
        window.location.href = "{{ url_for('logout') }}";
      });
    }

    // æ­·å²ç´€éŒ„æŒ‰éˆ• (å¦‚æœå­˜åœ¨)
    const historyButton = document.getElementById('history-button');
    if (historyButton) {
      historyButton.addEventListener("click", () => {
          console.log("History button clicked - functionality may need review.");
      });
    }

    const themeToggleButton = document.getElementById('theme-toggle-button');
const bodyElement = document.body; // æˆ–è€… document.documentElement ç²å– <html> æ¨™ç±¤

// å‡½æ•¸ï¼šæ‡‰ç”¨ä¸»é¡Œ
function applyTheme(theme) {
    bodyElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme); // å°‡åå¥½å„²å­˜åˆ° localStorage
    // æ›´æ–°æŒ‰éˆ•åœ–ç¤º (é›–ç„¶ CSS æœƒè™•ç†ï¼Œä½† JS ä¹Ÿå¯ä»¥è¼”åŠ©ç¢ºä¿ç‹€æ…‹æ­£ç¢º)
    const sunIcon = themeToggleButton.querySelector('.sun-icon');
    const moonIcon = themeToggleButton.querySelector('.moon-icon');
    if (theme === 'dark') {
        if (sunIcon) sunIcon.style.display = 'none';
        if (moonIcon) moonIcon.style.display = 'inline';
    } else {
        if (sunIcon) sunIcon.style.display = 'inline';
        if (moonIcon) moonIcon.style.display = 'none';
    }
    console.log("Theme applied:", theme);
}

// å‡½æ•¸ï¼šåˆ‡æ›ä¸»é¡Œ
function toggleTheme() {
    const currentTheme = bodyElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    applyTheme(newTheme);
}

// äº‹ä»¶ç›£è½å™¨ï¼šé»æ“ŠæŒ‰éˆ•æ™‚åˆ‡æ›ä¸»é¡Œ
if (themeToggleButton) {
    themeToggleButton.addEventListener('click', toggleTheme);
}

// åˆå§‹åŒ–ä¸»é¡Œï¼šæª¢æŸ¥ localStorage ä¸­æ˜¯å¦æœ‰ä¿å­˜çš„åå¥½ï¼Œå¦å‰‡é»˜èªç‚ºæ·ºè‰²
document.addEventListener('DOMContentLoaded', () => {
    // ... ä½ ç¾æœ‰çš„ DOMContentLoaded å…§å®¹ (ä¾‹å¦‚ formatAllLocalTimes) ...

    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

    if (savedTheme) {
        applyTheme(savedTheme);
    } else if (prefersDark) {
        // å¦‚æœç”¨æˆ¶ç³»çµ±åå¥½æ·±è‰²ä¸”æ²’æœ‰ä¿å­˜è¨­ç½®ï¼Œå‰‡é»˜èªç‚ºæ·±è‰² (å¯é¸)
        // applyTheme('dark');
        applyTheme('light'); // æˆ–è€…å§‹çµ‚é»˜èªç‚ºæ·ºè‰²
    } else {
        applyTheme('light'); // é»˜èªç‚ºæ·ºè‰²ä¸»é¡Œ
    }
});

// â­â­ æ–°å¢ï¼šæ»¾å‹•æŒ‰éˆ•ç›¸é—œçš„ JavaScript â­â­
const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
const scrollToBottomBtn = document.getElementById('scroll-to-bottom-btn');
// æˆ‘å€‘éœ€è¦æ»¾å‹•çš„æ˜¯å“ªå€‹å…ƒç´ ï¼Ÿé€šå¸¸æ˜¯ windowï¼Œæˆ–è€…æŸå€‹ç‰¹å®šçš„å¯æ»¾å‹•å®¹å™¨ã€‚
// åœ¨ä½ çš„ä½ˆå±€ä¸­ï¼Œ`#main-content` æ˜¯ä¸»è¦çš„æ»¾å‹•å€åŸŸã€‚
// ä½†å¦‚æœå´é‚Šæ¬„å›ºå®šï¼Œä¸”ä¸»å…§å®¹æº¢å‡ºè¦–çª—ï¼Œå‰‡æ»¾å‹•çš„ç›®æ¨™æ˜¯ window/documentã€‚
// ç‚ºäº†é€šç”¨æ€§ï¼Œæˆ‘å€‘å…ˆå‡è¨­æ˜¯æ•´å€‹é é¢çš„æ»¾å‹•ã€‚
// const scrollableElement = document.documentElement; // æˆ–è€… document.bodyï¼Œæˆ–è€… window

// ç›£è½çª—å£æ»¾å‹•äº‹ä»¶ï¼Œä»¥æ§åˆ¶â€œæ»¾å‹•åˆ°é ‚éƒ¨â€æŒ‰éˆ•çš„é¡¯ç¤º/éš±è—
window.onscroll = function() {
    scrollFunction();
};

function scrollFunction() {
    // ç•¶ç”¨æˆ¶å‘ä¸‹æ»¾å‹•è¶…é 200px (å¯èª¿æ•´) æ™‚ï¼Œé¡¯ç¤ºâ€œæ»¾å‹•åˆ°é ‚éƒ¨â€æŒ‰éˆ•
    if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
        if (scrollToTopBtn) scrollToTopBtn.style.display = "flex"; // æ”¹ç‚º flex ä»¥åŒ¹é… CSS
    } else {
        if (scrollToTopBtn) scrollToTopBtn.style.display = "none";
    }

    // å¯é¸ï¼šç•¶æ»¾å‹•åˆ°åº•éƒ¨æ™‚éš±è—â€œæ»¾å‹•åˆ°åº•éƒ¨â€æŒ‰éˆ•
    if (scrollToBottomBtn) {
        // (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 5 // æ¥è¿‘åº•éƒ¨5px
        // æª¢æŸ¥æ˜¯å¦æ»¾å‹•åˆ°åº•éƒ¨ (è€ƒæ…®ä¸€äº›å®¹å·®)
        const nearBottom = (window.innerHeight + window.pageYOffset) >= document.documentElement.scrollHeight ;
        if (nearBottom) {
            scrollToBottomBtn.style.display = "none";
        } else {
            scrollToBottomBtn.style.display = "flex"; // æ”¹ç‚º flex
        }
    }
}

// ç‚ºâ€œæ»¾å‹•åˆ°é ‚éƒ¨â€æŒ‰éˆ•æ·»åŠ é»æ“Šäº‹ä»¶ç›£è½å™¨
if (scrollToTopBtn) {
    scrollToTopBtn.addEventListener('click', function() {
        // å¹³æ»‘æ»¾å‹•åˆ°é é¢é ‚éƒ¨
        window.scrollTo({
            top: 0,
            behavior: 'smooth' // å¹³æ»‘æ»¾å‹•æ•ˆæœ
        });
        // document.body.scrollTop = 0; // For Safari
        // document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
    });
}

// ç‚ºâ€œæ»¾å‹•åˆ°åº•éƒ¨â€æŒ‰éˆ•æ·»åŠ é»æ“Šäº‹ä»¶ç›£è½å™¨
if (scrollToBottomBtn) {
    scrollToBottomBtn.addEventListener('click', function() {
        // å¹³æ»‘æ»¾å‹•åˆ°é é¢åº•éƒ¨
        window.scrollTo({
            top: document.documentElement.scrollHeight, // æ»¾å‹•åˆ°æ–‡æª”ç¸½é«˜åº¦
            behavior: 'smooth'
        });
    });
}
  </script>
</body>

</html>